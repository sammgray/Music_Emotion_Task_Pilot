<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Music Emotion Experiment - Block 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            touch-action: manipulation;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        .screen {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: auto;
            padding: 20px 0;
        }

        .screen.active {
            display: block;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .intro-text {
            font-size: 1.0em;
            line-height: 1.6;
            margin-bottom: 30px;
            text-align: left;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .continue-btn-bottom {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .skip-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            font-size: 0.9em;
            padding: 10px 15px;
            color: black;
        }

        .audio-controls {
            margin: 30px 0;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #4ECDC4);
            width: 0%;
            transition: width 0.1s ease;
        }

        .rating-section {
            margin: 15px 0;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .rating-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #FFD700;
        }

        .rating-scale {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            flex-wrap: nowrap;
            gap: 2px;
        }

        .rating-option {
            width: 100px;
            height: 100px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            margin: 1px;
            position: relative;
            overflow: hidden;
        }

        .rating-option img {
            width: 95px;
            height: 95px;
            object-fit: cover;
            object-position: center;
        }

        .rating-option.blank {
            background: transparent;
            border: 2px solid black;
            width: 80px;
            height: 80px;
            border-radius: 0;
        }

        .rating-option:hover {
            border-color: #FFD700;
            transform: scale(1.1);
        }

        .rating-option.selected {
            border-color: #FFD700;
            transform: scale(1.1);
        }

        .multiple-choice-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .choice-option {
            flex: 1;
            min-width: 50px;
            padding: 6px 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            text-align: center;
            margin: 2px;
        }

        .choice-option:hover {
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .choice-option.selected {
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .fixation-cross {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: white;
            font-family: monospace;
            z-index: 20;
            text-align: center;
        }

        /* Start Audio Button */
        .start-audio-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            padding: 20px 40px;
            font-size: 1.5em;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 25;
        }

        .start-audio-btn:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        /* Gray background for audio screen - full screen override */
        #audio-screen {
            background-color: #808080 !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 5;
        }

        /* Override the container background when audio screen is active */
        .container:has(#audio-screen.active) {
            background: #808080 !important;
        }

        /* Alternative approach - override body background when audio screen is shown */
        body.audio-playing {
            background: #808080 !important;
        }

        /* Rating screen - white background */
        body.rating-screen-active {
            background: white !important;
        }

        #rating-screen {
            background: white !important;
            color: black !important;
        }

        #rating-screen .container {
            background: white !important;
        }

        #rating-screen h2 {
            color: #1e3c72 !important;
        }

        #rating-screen .rating-title {
            color: #1e3c72 !important;
        }

        #rating-screen .rating-section {
            background: transparent !important;
            border: none !important;
        }

        #rating-screen .audio-title {
            color: black !important;
        }

        #rating-screen .choice-option {
            color: black !important;
            border-color: black !important;
        }

        #rating-screen .choice-option:hover {
            border-color: #FFD700 !important;
        }

        #rating-screen .choice-option.selected {
            border-color: #FFD700 !important;
            background: transparent !important;
            color: black !important;
        }

        /* Keep trial counter visible but subtle */
        #audio-screen .trial-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            color: white;
            z-index: 15;
        }

        .completion-screen {
            text-align: center;
        }

        .download-btn {
            background: linear-gradient(45deg, #4ECDC4, #45B7AF);
            margin-top: 20px;
        }

        .practice-header {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #FFD700;
        }

        .block-header {
            background: rgba(76, 175, 80, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #4CAF50;
        }

        /* Feedback question styles */
        .feedback-question {
            margin: 20px 0;
            background: transparent;
            padding: 20px;
            border-radius: 15px;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 10px;
            background: white;
            color: black;
            font-size: 1em;
            font-family: Arial, sans-serif;
            resize: vertical;
            margin-top: 10px;
        }

        .feedback-textarea::placeholder {
            color: #666;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }

        /* Feedback screen - white background like rating screen */
        body.feedback-screen-active {
            background: white !important;
        }

        #feedback-screen {
            background: white !important;
            color: black !important;
        }

        #feedback-screen .container {
            background: white !important;
        }

        .feedback-question-title {
            color: black !important;
            font-size: 1.3em;
            font-weight: normal;
            margin-bottom: 20px;
            text-align: left;
        }

        @media (max-width: 768px) {
            .rating-option {
                width: 85px;
                height: 85px;
            }
            
            .rating-option img {
                width: 80px;
                height: 80px;
            }
            
            .rating-option.blank {
                width: 65px;
                height: 65px;
                background: transparent;
                border: 2px solid black;
                border-radius: 0;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .intro-text {
                font-size: 1em;
            }

            .choice-option {
                font-size: 0.7em;
                padding: 4px 6px;
                min-width: 40px;
            }

            .start-audio-btn {
                font-size: 1.2em;
                padding: 15px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Introduction Screen -->
        <div class="screen active" id="intro-screen">
            <div class="block-header">
                <h2>Block 1 of 3</h2>
                <p>This is the first block of the music emotion experiment</p>
            </div>
            <h1>Music Emotion Experiment</h1>
            <div class="intro-text">
                <p>In the following experiment, we would like you to listen to a series of music clips and rate a few things:</p>
                <br>
                <p>1. Your experienced valence, or <strong>how positive/negative the music makes you feel</strong></p>
                <p>2. Your arousal levels, or the <strong>intensity of how you feel</strong></p>
                <p>3. Your <strong>familiarity</strong> with the music</p>
                <p>4. The "groove" of the music, or <strong>how much the music makes you want to dance</strong></p>
                <br>
                <p><strong>Please try your best to keep your eyes focused on the white cross while listening. Also, please turn up your volume to at least 75% of max volume.</strong></p>
                <br>
                <p>Each clip lasts 30 seconds. Occasionally, the music you hear will consist only of rhythmic sequences. After each clip, regardless of whether you heard a song or a drum loop, you will be asked the questions mentioned above.</p>
                <br>
                <p>First, we will practice rating some music to familiarize you with the surveys. Once you finish the practice, the full questions will no longer appear for each survey, and will instead be labeled on each end of the scale.</p>
                <br>
                <p style="color: #ff4444; font-weight: bold; font-size: 1.1em;">**IMPORTANT: At the end of this block, you MUST download your data to save your responses!**</p>
                <br>
                <p>To begin, hit the continue button below.</p>
            </div>
            <button class="btn" onclick="startPractice()">Continue</button>
            <button class="btn" onclick="recoverStoredData()" style="position: fixed; bottom: 20px; left: 20px; background: linear-gradient(45deg, #95a5a6, #7f8c8d); font-size: 0.9em; padding: 10px 15px;">Recover Old Data</button>
        </div>

        <!-- Practice Introduction Screen -->
        <div class="screen" id="practice-intro-screen">
            <div class="practice-header">
                <h2>Practice Session</h2>
                <p>Let's start with a brief practice using practice music clips</p>
            </div>
            <div class="intro-text">
                <p>You will:</p>
                <ul style="margin-left: 20px;">
                    <li>Listen to practice music clips (10 seconds each)</li>
                    <li>Rate your emotional responses after each clip</li>
                    <li>Get familiar with the rating scales</li>
                </ul>
                <br>
                <p>Click Continue when you're ready to begin the practice, or Skip if you've done this before.</p>
            </div>
            <button class="btn" onclick="startPracticeTrials()">Continue to Practice</button>
            <button class="btn" onclick="skipPractice()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-left: 20px;">Skip Practice</button>
        </div>

        <!-- Audio Playback Screen -->
        <div class="screen" id="audio-screen">
            <div class="trial-info" id="trial-counter">Trial 1 of 9</div>
            <div class="fixation-cross" id="fixation-cross" style="display: none;">+</div>
            <button class="start-audio-btn" id="start-audio-btn" onclick="startAudioPlayback()">Start Audio</button>
        </div>

        <!-- Rating Screen -->
        <div class="screen" id="rating-screen">
            <h2 id="rating-header">Rate Your Response</h2>

            <!-- Valence Rating -->
            <div class="rating-section">
                <div class="rating-title">How positive or negative does this music make you feel?</div>
                <div class="rating-scale" id="valence-scale">
                    <div class="rating-option" data-value="1">
                        <img src="stimuli/SAM/valence1.png" alt="Very Negative">
                    </div>
                    <div class="rating-option blank" data-value="1.5"></div>
                    <div class="rating-option" data-value="2">
                        <img src="stimuli/SAM/valence2.png" alt="Negative">
                    </div>
                    <div class="rating-option blank" data-value="2.5"></div>
                    <div class="rating-option" data-value="3">
                        <img src="stimuli/SAM/valence3.png" alt="Neutral">
                    </div>
                    <div class="rating-option blank" data-value="3.5"></div>
                    <div class="rating-option" data-value="4">
                        <img src="stimuli/SAM/valence4.png" alt="Positive">
                    </div>
                    <div class="rating-option blank" data-value="4.5"></div>
                    <div class="rating-option" data-value="5">
                        <img src="stimuli/SAM/valence5.png" alt="Very Positive">
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Negative</span>
                    <span>Neutral</span>
                    <span>Positive</span>
                </div>
            </div>

            <!-- Arousal Rating -->
            <div class="rating-section">
                <div class="rating-title">How intense is that feeling?</div>
                <div class="rating-scale" id="arousal-scale">
                    <div class="rating-option" data-value="1">
                        <img src="stimuli/SAM/arousal5.png" alt="Very Excited">
                    </div>
                    <div class="rating-option blank" data-value="1.5"></div>
                    <div class="rating-option" data-value="2">
                        <img src="stimuli/SAM/arousal4.png" alt="Excited">
                    </div>
                    <div class="rating-option blank" data-value="2.5"></div>
                    <div class="rating-option" data-value="3">
                        <img src="stimuli/SAM/arousal3.png" alt="Neutral">
                    </div>
                    <div class="rating-option blank" data-value="3.5"></div>
                    <div class="rating-option" data-value="4">
                        <img src="stimuli/SAM/arousal2.png" alt="Calm">
                    </div>
                    <div class="rating-option blank" data-value="4.5"></div>
                    <div class="rating-option" data-value="5">
                        <img src="stimuli/SAM/arousal1.png" alt="Very Calm">
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Neutral</span>
                    <span>Very Intense</span>
                </div>
            </div>

            <!-- Familiarity Rating -->
            <div class="rating-section">
                <div class="rating-title">How familiar were you with this music before today?</div>
                <div class="multiple-choice-container" id="familiarity-scale">
                    <div class="choice-option" data-value="1">1</div>
                    <div class="choice-option" data-value="2">2</div>
                    <div class="choice-option" data-value="3">3</div>
                    <div class="choice-option" data-value="4">4</div>
                    <div class="choice-option" data-value="5">5</div>
                    <div class="choice-option" data-value="6">6</div>
                    <div class="choice-option" data-value="7">7</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Not familiar at all</span>
                    <span>Very familiar</span>
                </div>
            </div>

            <!-- Groove Rating -->
            <div class="rating-section">
                <div class="rating-title">How would you rate the "groove" of this music?</div>
                <div class="multiple-choice-container" id="groove-scale">
                    <div class="choice-option" data-value="0">0</div>
                    <div class="choice-option" data-value="1">1</div>
                    <div class="choice-option" data-value="2">2</div>
                    <div class="choice-option" data-value="3">3</div>
                    <div class="choice-option" data-value="4">4</div>
                    <div class="choice-option" data-value="5">5</div>
                    <div class="choice-option" data-value="6">6</div>
                    <div class="choice-option" data-value="7">7</div>
                    <div class="choice-option" data-value="8">8</div>
                    <div class="choice-option" data-value="9">9</div>
                    <div class="choice-option" data-value="10">10</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Not groovy at all</span>
                    <span>Very groovy</span>
                </div>
            </div>

            <button class="btn continue-btn-bottom" id="continue-btn" onclick="nextTrial()" disabled>Continue</button>
            <button class="skip-btn" onclick="skipAllRatings()">Skip All</button>
        </div>

        <!-- Practice Complete Screen -->
        <div class="screen" id="practice-complete-screen">
            <div class="practice-header">
                <h2>Practice Complete!</h2>
            </div>
            <div class="intro-text">
                <p>You've completed the practice session.</p>
                <br>
                <p>Now you'll begin Block 1 of the main experiment with the same type of ratings.</p>
                <br>
                <p>Block 1 contains 9 music clips.</p>
            </div>
            <button class="btn" onclick="startMainExperiment()">Start Block 1</button>
        </div>

        <!-- Feedback Question Screen -->
        <div class="screen" id="feedback-screen">
            <div class="feedback-question">
                <div class="feedback-question-title">How did you rate the songs? Would you say that you were rating the emotional impact of the song or how much you liked the song? Please enter your response below:</div>
                <textarea class="feedback-textarea" id="feedback-response" placeholder="Please describe your approach to rating the songs..."></textarea>
            </div>
            <button class="btn" onclick="submitFeedback()">Submit and Continue</button>
        </div>

        <!-- Completion Screen -->
        <div class="screen" id="completion-screen">
            <div class="completion-screen">
                <h1>Congratulations! You have completed Block 1.</h1>
                <p style="color: #ff4444; font-weight: bold; font-size: 1.2em; margin: 20px 0;">PLEASE MAKE SURE TO DOWNLOAD YOUR DATA BELOW</p>
                <button class="btn download-btn" onclick="downloadData()">Download Block 1 Data</button>
                <p style="margin: 20px 0;" id="completion-message">Close this tab and continue to the next block when you are ready by clicking on the next block on the home screen.</p>
            </div>
        </div>
    </div>

    <script>
        // Experiment Configuration
        const AUDIO_DURATION = 30000; // 30 seconds in milliseconds
        const PRACTICE_AUDIO_DURATION = 10000; // 10 seconds for practice
        const REPETITIONS_PER_SONG = 1; // Changed from 3 to 1
        
        // Block 1 songs (first 9 songs from original list)
        const DEMO_SONGS = [
            { 
                filename: 'stimuli/audio/1252', 
                title: '1252',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/dupleMeter_stereo_30sec', 
                title: 'Duple Meter Stereo',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/69', 
                title: '69',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/399', 
                title: '399',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/425', 
                title: '425',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/612', 
                title: '612',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/649', 
                title: '649',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/657', 
                title: '657',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/799', 
                title: '799',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            }
        ];

        // Practice songs - separate array for songs with "practice" in filename
        const PRACTICE_SONGS_LIST = [
            { 
                filename: 'stimuli/audio/practice1_808', 
                title: 'Practice 1',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/practice2_1092', 
                title: 'Practice 2',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            }
        ];

        // Experiment State
        let participantId = 'participant_block1_' + Date.now();
        let currentTrial = 0;
        let trials = [];
        let experimentData = [];
        let practiceData = [];
        let currentAudio = null;
        let audioStartTime = 0;
        let surveyStartTime = 0;
        let valenceRating = null;
        let arousalRating = null;
        let familiarityRating = null;
        let grooveRating = null;
        let valenceRT = null;
        let arousalRT = null;
        let familiarityRT = null;
        let grooveRT = null;
        let isPractice = false;
        let practiceTrials = [];
        let currentSong = null;
        let feedbackResponse = '';
        let isDownloading = false;

        // Auto-save when page is about to close
        window.addEventListener('beforeunload', function(e) {
            if (experimentData.length > 0 || practiceData.length > 0) {
                saveDataToFile();
            }
        });

        // Auto-save when page visibility changes (tab switch, etc.)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && (experimentData.length > 0 || practiceData.length > 0)) {
                saveDataToFile();
            }
        });

        // Initialize practice
        function initializePractice() {
            practiceTrials = [];
            for (let i = 0; i < PRACTICE_SONGS_LIST.length; i++) {
                practiceTrials.push({
                    song: PRACTICE_SONGS_LIST[i],
                    repetition: 1
                });
            }
        }

        // Initialize main experiment
        function initializeExperiment() {
            // Create randomized trial list (use all DEMO_SONGS for main experiment)
            trials = [];
            for (let song of DEMO_SONGS) {
                for (let rep = 0; rep < REPETITIONS_PER_SONG; rep++) {
                    trials.push({
                        song: song,
                        repetition: rep + 1
                    });
                }
            }
            
            // Shuffle trials
            for (let i = trials.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [trials[i], trials[j]] = [trials[j], trials[i]];
            }
        }

        // Skip function for all ratings
        function skipAllRatings() {
            if (valenceRating === null) {
                valenceRT = Date.now() - surveyStartTime;
            }
            if (arousalRating === null) {
                arousalRT = Date.now() - surveyStartTime;
            }
            if (familiarityRating === null) {
                familiarityRT = Date.now() - surveyStartTime;
            }
            if (grooveRating === null) {
                grooveRT = Date.now() - surveyStartTime;
            }
            
            valenceRating = 'skip';
            arousalRating = 'skip';
            familiarityRating = 'skip';
            grooveRating = 'skip';
            
            // Remove any existing selections
            document.querySelectorAll('.rating-option, .choice-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            checkAllRatingsComplete();
        }

        function submitFeedback() {
            feedbackResponse = document.getElementById('feedback-response').value;
            showScreen('completion-screen');
        }

        function startPractice() {
            showScreen('practice-intro-screen');
        }

        function startPracticeTrials() {
            isPractice = true;
            initializePractice();
            currentTrial = 0;
            showScreen('audio-screen');
            startTrial();
        }

        function skipPractice() {
            showScreen('practice-complete-screen');
        }

        function startMainExperiment() {
            isPractice = false;
            initializeExperiment();
            currentTrial = 0;
            showScreen('audio-screen');
            startTrial();
        }

        function startTrial() {
            const currentTrials = isPractice ? practiceTrials : trials;
            
            if (currentTrial >= currentTrials.length) {
                if (isPractice) {
                    showScreen('practice-complete-screen');
                } else {
                    endExperiment();
                }
                return;
            }

            const trial = currentTrials[currentTrial];
            const totalTrials = isPractice ? practiceTrials.length : trials.length;
            const trialLabel = isPractice ? 'Practice' : 'Trial';
            document.getElementById('trial-counter').textContent = `${trialLabel} ${currentTrial + 1} of ${totalTrials}`;
            
            currentSong = trial.song;
            document.getElementById('start-audio-btn').style.display = 'block';
            document.getElementById('fixation-cross').style.display = 'none';
        }

        function startAudioPlayback() {
            document.getElementById('start-audio-btn').style.display = 'none';
            document.getElementById('fixation-cross').style.display = 'block';
            
            const filename = currentSong.filename + '.mp3';
            currentAudio = new Audio(filename);
            currentAudio.volume = 0.8;
            
            const startTime = currentSong.filename.includes('dupleMeter') ? 0 : 10;
            currentAudio.currentTime = startTime;
            audioStartTime = Date.now();
            
            const playPromise = currentAudio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    startAudioTimer();
                }).catch(error => {
                    playAudioClip(currentSong);
                });
            }
        }
        
        function startAudioTimer() {
            const duration = isPractice ? PRACTICE_AUDIO_DURATION : AUDIO_DURATION;
            let audioEnded = false;
            
            const updateProgress = () => {
                if (audioEnded) return;
                
                const elapsed = Date.now() - audioStartTime;
                const progress = Math.min((elapsed / duration) * 100, 100);
                
                if (progress >= 100) {
                    audioEnded = true;
                    if (currentAudio) {
                        currentAudio.pause();
                    }
                    setTimeout(() => {
                        showRatingScreen();
                    }, 500);
                } else {
                    requestAnimationFrame(updateProgress);
                }
            };
            
            updateProgress();
        }

        function findWorkingAudioFile(song) {
            return new Promise((resolve, reject) => {
                let formatIndex = 0;
                
                function tryNextFormat() {
                    if (formatIndex >= song.formats.length) {
                        reject('No supported audio format found for: ' + song.title);
                        return;
                    }
                    
                    const filename = song.filename + song.formats[formatIndex];
                    const audio = new Audio();
                    
                    audio.addEventListener('canplaythrough', function() {
                        console.log('Found working format:', filename);
                        resolve(filename);
                    });
                    
                    audio.addEventListener('error', function() {
                        console.log('Format not supported or file not found:', filename);
                        formatIndex++;
                        tryNextFormat();
                    });
                    
                    audio.src = filename;
                    audio.load();
                }
                
                tryNextFormat();
            });
        }

        function playAudioClip(song) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            console.log('Attempting to find working audio file for:', song.title);
            
            const duration = isPractice ? PRACTICE_AUDIO_DURATION : AUDIO_DURATION;
            
            findWorkingAudioFile(song).then(workingFilename => {
                console.log('Using audio file:', workingFilename);
                
                currentAudio = new Audio(workingFilename);
                currentAudio.volume = 0.8;
                currentAudio.preload = 'auto';
                
                audioStartTime = Date.now();
                let audioEnded = false;
                
                currentAudio.addEventListener('loadeddata', function() {
                    console.log('Audio loaded successfully');
                    const startTime = song.filename.includes('dupleMeter') ? 0 : 10;
                    currentAudio.currentTime = startTime;
                });
                
                currentAudio.addEventListener('error', function(e) {
                    console.log('Audio playback error:', e);
                    handleAudioFailure(song);
                });
                
                const playPromise = currentAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Audio started playing successfully');
                        const startTime = song.filename.includes('dupleMeter') ? 0 : 10;
                        currentAudio.currentTime = startTime;
                    }).catch(error => {
                        console.log('Audio play failed:', error);
                        handleAudioFailure(song);
                    });
                }
                
                const updateProgress = () => {
                    if (audioEnded) return;
                    
                    const elapsed = Date.now() - audioStartTime;
                    const progress = Math.min((elapsed / duration) * 100, 100);
                    
                    if (progress >= 100) {
                        audioEnded = true;
                        if (currentAudio) {
                            currentAudio.pause();
                        }
                        console.log(`${duration/1000} seconds elapsed, moving to rating screen`);
                        setTimeout(() => {
                            showRatingScreen();
                        }, 500);
                    } else {
                        requestAnimationFrame(updateProgress);
                    }
                };
                
                updateProgress();
                
            }).catch(error => {
                console.log('No working audio format found:', error);
                handleAudioFailure(song);
            });
        }
        
        function handleAudioFailure(song) {
            const duration = isPractice ? PRACTICE_AUDIO_DURATION : AUDIO_DURATION;
            console.log('Audio failed for:', song.title, '- continuing with silent playback');
            alert('Cannot play audio for: ' + song.title + '\n\nPossible issues:\n1. File not found in audio folder\n2. Unsupported format\n3. File name mismatch\n\nContinuing with ' + (duration/1000) + '-second silent period...');
            
            setTimeout(() => {
                showRatingScreen();
            }, duration);
        }

        function showRatingScreen() {
            const currentTrials = isPractice ? practiceTrials : trials;
            const trial = currentTrials[currentTrial];
            
            const header = isPractice ? 'Practice - Rate Your Response' : 'Rate Your Response';
            document.getElementById('rating-header').textContent = header;
            
            const ratingTitles = document.querySelectorAll('.rating-title');
            ratingTitles.forEach(title => {
                if (isPractice) {
                    title.style.display = 'block';
                } else {
                    title.style.display = 'none';
                }
            });
            
            resetRatings();
            surveyStartTime = Date.now();
            
            showScreen('rating-screen');
        }

        function resetRatings() {
            document.querySelectorAll('.rating-option, .choice-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            valenceRating = null;
            arousalRating = null;
            familiarityRating = null;
            grooveRating = null;
            valenceRT = null;
            arousalRT = null;
            familiarityRT = null;
            grooveRT = null;
            
            document.getElementById('continue-btn').disabled = true;
        }

        // Rating scale interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Valence scale
            document.getElementById('valence-scale').addEventListener('click', function(e) {
                if (e.target.closest('.rating-option')) {
                    const option = e.target.closest('.rating-option');
                    if (valenceRating === null || valenceRating === 'skip') {
                        valenceRT = Date.now() - surveyStartTime;
                    }
                    
                    document.querySelectorAll('#valence-scale .rating-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    option.classList.add('selected');
                    valenceRating = parseFloat(option.dataset.value);
                    
                    checkAllRatingsComplete();
                }
            });

            // Arousal scale
            document.getElementById('arousal-scale').addEventListener('click', function(e) {
                if (e.target.closest('.rating-option')) {
                    const option = e.target.closest('.rating-option');
                    if (arousalRating === null || arousalRating === 'skip') {
                        arousalRT = Date.now() - surveyStartTime;
                    }
                    
                    document.querySelectorAll('#arousal-scale .rating-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    option.classList.add('selected');
                    arousalRating = parseFloat(option.dataset.value);
                    
                    checkAllRatingsComplete();
                }
            });

            // Familiarity scale
            document.getElementById('familiarity-scale').addEventListener('click', function(e) {
                if (e.target.classList.contains('choice-option')) {
                    if (familiarityRating === null || familiarityRating === 'skip') {
                        familiarityRT = Date.now() - surveyStartTime;
                    }
                    
                    document.querySelectorAll('#familiarity-scale .choice-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    e.target.classList.add('selected');
                    familiarityRating = parseInt(e.target.dataset.value);
                    
                    checkAllRatingsComplete();
                }
            });

            // Groove scale
            document.getElementById('groove-scale').addEventListener('click', function(e) {
                if (e.target.classList.contains('choice-option')) {
                    if (grooveRating === null || grooveRating === 'skip') {
                        grooveRT = Date.now() - surveyStartTime;
                    }
                    
                    document.querySelectorAll('#groove-scale .choice-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    e.target.classList.add('selected');
                    grooveRating = parseInt(e.target.dataset.value);
                    
                    checkAllRatingsComplete();
                }
            });
        });

        function checkAllRatingsComplete() {
            if ((valenceRating !== null) && (arousalRating !== null) && 
                (familiarityRating !== null) && (grooveRating !== null)) {
                document.getElementById('continue-btn').disabled = false;
            }
        }

        function nextTrial() {
            const currentTrials = isPractice ? practiceTrials : trials;
            const trial = currentTrials[currentTrial];
            const duration = isPractice ? PRACTICE_AUDIO_DURATION : AUDIO_DURATION;
            
            const startTime = trial.song.filename.includes('dupleMeter') ? 0 : 10;
            const trialData = {
                participant_id: participantId,
                block: 1,
                trial_number: currentTrial + 1,
                music_clip_title: trial.song.title,
                playback_number: trial.repetition,
                audio_start_time_seconds: startTime,
                music_onset_time: audioStartTime,
                music_offset_time: audioStartTime + duration,
                emotion_survey_onset_time: surveyStartTime,
                valence_rating: valenceRating,
                valence_response_time: valenceRT,
                arousal_rating: arousalRating,
                arousal_response_time: arousalRT,
                familiarity_rating: familiarityRating,
                familiarity_response_time: familiarityRT,
                groove_rating: grooveRating,
                groove_response_time: grooveRT,
                timestamp: new Date().toISOString(),
                is_practice: isPractice
            };
            
            if (isPractice) {
                practiceData.push(trialData);
                saveTrialToLocalStorage(trialData, 'practice');
                console.log(`Practice trial ${currentTrial + 1} data saved to memory. Total practice trials: ${practiceData.length}`);
            } else {
                experimentData.push(trialData);
                saveTrialToLocalStorage(trialData, 'main');
                console.log(`Trial ${currentTrial + 1} data saved to memory. Total trials: ${experimentData.length}`);
            }
            
            currentTrial++;
            
            setTimeout(() => {
                if (currentTrial < currentTrials.length) {
                    showScreen('audio-screen');
                    startTrial();
                } else {
                    if (isPractice) {
                        showScreen('practice-complete-screen');
                    } else {
                        endExperiment();
                    }
                }
            }, 1000);
        }

        function saveDataToFile() {
            if (experimentData.length === 0 && practiceData.length === 0) {
                console.log('No data to save');
                return;
            }
            
            try {
                const allData = [...practiceData, ...experimentData];
                
                // Add separate feedback row at the end for auto-save as well
                if (feedbackResponse) {
                    const feedbackRow = {
                        participant_id: participantId,
                        block: 1,
                        trial_number: null,
                        music_clip_title: null,
                        playback_number: null,
                        audio_start_time_seconds: null,
                        music_onset_time: null,
                        music_offset_time: null,
                        emotion_survey_onset_time: null,
                        valence_rating: null,
                        valence_response_time: null,
                        arousal_rating: null,
                        arousal_response_time: null,
                        familiarity_rating: null,
                        familiarity_response_time: null,
                        groove_rating: null,
                        groove_response_time: null,
                        timestamp: new Date().toISOString(),
                        is_practice: null,
                        feedback_response: feedbackResponse
                    };
                    allData.push(feedbackRow);
                }
                
                const csvContent = convertToCSV(allData);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music_emotion_data_block1_${participantId}_${new Date().toISOString().split('T')[0]}.csv`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                console.log(`Auto-saved CSV with ${practiceData.length} practice + ${experimentData.length} main trials for participant: ${participantId}`);
                
            } catch (error) {
                console.log('Auto-save failed:', error);
            }
        }

        function saveTrialToLocalStorage(trialData, trialType) {
            try {
                const key = `block1_${participantId}_${trialType}_trial_${trialData.trial_number}`;
                localStorage.setItem(key, JSON.stringify(trialData));
                console.log(`Trial ${trialData.trial_number} saved to localStorage`);
            } catch (error) {
                console.log('LocalStorage save failed:', error);
            }
        }

        function downloadAllStoredData() {
            try {
                const allTrials = [];
                const keyPrefix = `block1_${participantId}_`;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(keyPrefix)) {
                        const trialData = JSON.parse(localStorage.getItem(key));
                        allTrials.push(trialData);
                    }
                }
                
                if (allTrials.length === 0) {
                    console.log('No stored data found for this participant');
                    return;
                }
                
                allTrials.sort((a, b) => a.trial_number - b.trial_number);
                
                const csvContent = convertToCSV(allTrials);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music_emotion_block1_ALL_TRIALS_${participantId}_${new Date().toISOString().split('T')[0]}.csv`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                console.log(`Downloaded ${allTrials.length} trials from localStorage`);
                
            } catch (error) {
                console.log('Download from localStorage failed:', error);
            }
        }

        function recoverStoredData() {
            try {
                const keyPrefix = `block1_`;
                let foundData = false;
                let participantIds = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(keyPrefix)) {
                        foundData = true;
                        const parts = key.split('_');
                        if (parts.length >= 3) {
                            const pid = parts[1] + '_' + parts[2];
                            if (!participantIds.includes(pid)) {
                                participantIds.push(pid);
                            }
                        }
                    }
                }
                
                if (!foundData) {
                    alert('No stored Block 1 data found');
                    return;
                }
                
                if (participantIds.length > 1) {
                    const choice = prompt(`Found data for ${participantIds.length} participants:\n${participantIds.join('\n')}\n\nEnter participant ID to recover:`);
                    if (choice && participantIds.includes(choice)) {
                        participantId = choice;
                    } else {
                        alert('Invalid participant ID');
                        return;
                    }
                } else if (participantIds.length === 1) {
                    participantId = participantIds[0];
                }
                
                downloadAllStoredData();
                
            } catch (error) {
                console.log('Recovery failed:', error);
                alert('Data recovery failed');
            }
        }

        function endExperiment() {
            if (experimentData.length > 0) {
                saveDataToFile();
                console.log('Block 1 completed - final data saved');
            }
            showScreen('feedback-screen');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'audio-screen') {
                document.body.classList.add('audio-playing');
                document.body.classList.remove('rating-screen-active', 'feedback-screen-active');
            } else if (screenId === 'rating-screen') {
                document.body.classList.add('rating-screen-active');
                document.body.classList.remove('audio-playing', 'feedback-screen-active');
            } else if (screenId === 'feedback-screen') {
                document.body.classList.add('feedback-screen-active');
                document.body.classList.remove('audio-playing', 'rating-screen-active');
            } else {
                document.body.classList.remove('audio-playing', 'rating-screen-active', 'feedback-screen-active');
            }
        }

        function downloadData() {
            if (isDownloading) {
                console.log('Download already in progress, preventing duplicate');
                return;
            }
            
            isDownloading = true;
            const downloadBtn = document.querySelector('.download-btn');
            const originalText = downloadBtn.textContent;
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';
            
            try {
                const allData = [...practiceData, ...experimentData];
                
                // Add separate feedback row at the end
                if (feedbackResponse) {
                    const feedbackRow = {
                        participant_id: participantId,
                        block: 1,
                        trial_number: null,
                        music_clip_title: null,
                        playback_number: null,
                        audio_start_time_seconds: null,
                        music_onset_time: null,
                        music_offset_time: null,
                        emotion_survey_onset_time: null,
                        valence_rating: null,
                        valence_response_time: null,
                        arousal_rating: null,
                        arousal_response_time: null,
                        familiarity_rating: null,
                        familiarity_response_time: null,
                        groove_rating: null,
                        groove_response_time: null,
                        timestamp: new Date().toISOString(),
                        is_practice: null,
                        feedback_response: feedbackResponse
                    };
                    allData.push(feedbackRow);
                }
                
                const csvContent = convertToCSV(allData);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music_emotion_data_block1_${participantId}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                document.getElementById('completion-message').innerHTML = 'Your responses have been recorded and downloaded! Close this tab and continue to the next block when you are ready by clicking on the next block on the home screen.';
                
            } catch (error) {
                console.log('Download failed:', error);
                document.getElementById('completion-message').innerHTML = 'Download may have failed. Please try again or contact the researcher.';
            }
            
            setTimeout(() => {
                isDownloading = false;
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }, 2000);
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value}"` : value;
                });
                csvRows.push(values.join(','));
            }
            
            return csvRows.join('\n');
        }

        function restartExperiment() {
            currentTrial = 0;
            experimentData = [];
            practiceData = [];
            isPractice = false;
            participantId = 'participant_block1_' + Date.now();
            showScreen('intro-screen');
        }
    </script>
</body>
</html>