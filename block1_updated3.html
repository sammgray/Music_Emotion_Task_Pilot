<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Music Emotion Experiment - Block 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            touch-action: manipulation;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        .screen {
            display: none;
            width: 100%;
            max-width: 800px;
            margin: auto;
            padding: 20px 0;
        }

        .screen.active {
            display: block;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .intro-text {
            font-size: 1.0em;
            line-height: 1.6;
            margin-bottom: 30px;
            text-align: left;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .continue-btn-bottom {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .skip-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            font-size: 0.9em;
            padding: 10px 15px;
        }

        .audio-controls {
            margin: 30px 0;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #4ECDC4);
            width: 0%;
            transition: width 0.1s ease;
        }

        .rating-section {
            margin: 15px 0;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .rating-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #FFD700;
        }

        .rating-scale {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 5px;
        }

        .rating-option {
            width: 90px;
            height: 90px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            margin: 3px;
            position: relative;
            overflow: hidden;
        }

        .rating-option img {
            width: 85px;
            height: 85px;
            object-fit: cover;
            object-position: center;
        }

        .rating-option.blank {
            background: transparent;
            border: 2px solid black;
            width: 75px;
            height: 75px;
            border-radius: 0;
        }

        .rating-option:hover {
            border-color: #FFD700;
            transform: scale(1.1);
        }

        .rating-option.selected {
            border-color: #FFD700;
            transform: scale(1.1);
        }

        .multiple-choice-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .choice-option {
            flex: 1;
            min-width: 50px;
            padding: 6px 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            text-align: center;
            margin: 2px;
        }

        .choice-option:hover {
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .choice-option.selected {
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .fixation-cross {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: white;
            font-family: monospace;
            z-index: 20;
            text-align: center;
        }

        /* Start Audio Button */
        .start-audio-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            padding: 20px 40px;
            font-size: 1.5em;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 25;
        }

        .start-audio-btn:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        /* Gray background for audio screen - full screen override */
        #audio-screen {
            background-color: #808080 !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 5;
        }

        /* Override the container background when audio screen is active */
        .container:has(#audio-screen.active) {
            background: #808080 !important;
        }

        /* Alternative approach - override body background when audio screen is shown */
        body.audio-playing {
            background: #808080 !important;
        }

        /* Rating screen - white background */
        body.rating-screen-active {
            background: white !important;
        }

        #rating-screen {
            background: white !important;
            color: black !important;
        }

        #rating-screen .container {
            background: white !important;
        }

        #rating-screen h2 {
            color: #1e3c72 !important;
        }

        #rating-screen .rating-title {
            color: #1e3c72 !important;
        }

        #rating-screen .rating-section {
            background: transparent !important;
            border: none !important;
        }

        #rating-screen .audio-title {
            color: black !important;
        }

        #rating-screen .choice-option {
            color: black !important;
            border-color: black !important;
        }

        #rating-screen .choice-option:hover {
            border-color: #FFD700 !important;
        }

        #rating-screen .choice-option.selected {
            border-color: #FFD700 !important;
            background: transparent !important;
            color: black !important;
        }

        /* Keep trial counter visible but subtle */
        #audio-screen .trial-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            color: white;
            z-index: 15;
        }

        .completion-screen {
            text-align: center;
        }

        .download-btn {
            background: linear-gradient(45deg, #4ECDC4, #45B7AF);
            margin-top: 20px;
        }

        .practice-header {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #FFD700;
        }

        .block-header {
            background: rgba(76, 175, 80, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #4CAF50;
        }

        /* Feedback question styles */
        .feedback-question {
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .feedback-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            font-family: Arial, sans-serif;
            resize: vertical;
            margin-top: 10px;
        }

        .feedback-textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: #FFD700;
        }

        @media (max-width: 768px) {
            .rating-option {
                width: 75px;
                height: 75px;
            }
            
            .rating-option img {
                width: 70px;
                height: 70px;
            }
            
            .rating-option.blank {
                width: 60px;
                height: 60px;
                background: transparent;
                border: 2px solid black;
                border-radius: 0;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .intro-text {
                font-size: 1em;
            }

            .choice-option {
                font-size: 0.7em;
                padding: 4px 6px;
                min-width: 40px;
            }

            .start-audio-btn {
                font-size: 1.2em;
                padding: 15px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Introduction Screen -->
        <div class="screen active" id="intro-screen">
            <div class="block-header">
                <h2>Block 1 of 3</h2>
                <p>This is the first block of the music emotion experiment</p>
            </div>
            <h1>Music Emotion Experiment</h1>
            <div class="intro-text">
                <p>In the following experiment, we would like you to listen to a series of music clips and rate a few things:</p>
                <br>
                <p>1. Your experienced valence, or <strong>how positive/negative the music makes you feel</strong></p>
                <p>2. Your arousal levels, or the <strong>intensity of how you feel</strong></p>
                <p>3. Your <strong>familiarity</strong> with the music</p>
                <p>4. The "groove" of the music, or <strong>how much the music makes you want to dance</strong></p>
                <br>
                <p>Each clip lasts 30 seconds. Occasionally, the music you hear will consist only of rhythmic sequences. After each clip, regardless of whether you heard a song or a drum loop, you will be asked the questions mentioned above.</p>
                <br>
                <p>First, we will practice rating some music to familiarize you with the surveys. Once you finish the practice, the full questions will no longer appear for each survey, and will instead be labeled on each end of the scale.</p>
                <br>
                <p style="color: #ff4444; font-weight: bold; font-size: 1.1em;">**IMPORTANT: At the end of this block, you MUST download your data to save your responses!**</p>
                <br>
                <p>To begin, hit the continue button below.</p>
            </div>
            <button class="btn" onclick="startPractice()">Continue</button>
            <button class="btn" onclick="recoverStoredData()" style="position: fixed; bottom: 20px; left: 20px; background: linear-gradient(45deg, #95a5a6, #7f8c8d); font-size: 0.9em; padding: 10px 15px;">Recover Old Data</button>
        </div>

        <!-- Practice Introduction Screen -->
        <div class="screen" id="practice-intro-screen">
            <div class="practice-header">
                <h2>Practice Session</h2>
                <p>Let's start with a brief practice using practice music clips</p>
            </div>
            <div class="intro-text">
                <p>You will:</p>
                <ul style="margin-left: 20px;">
                    <li>Listen to practice music clips (10 seconds each)</li>
                    <li>Rate your emotional responses after each clip</li>
                    <li>Get familiar with the rating scales</li>
                </ul>
                <br>
                <p>Click Continue when you're ready to begin the practice, or Skip if you've done this before.</p>
            </div>
            <button class="btn" onclick="startPracticeTrials()">Continue to Practice</button>
            <button class="btn" onclick="skipPractice()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-left: 20px;">Skip Practice</button>
        </div>

        <!-- Audio Playback Screen -->
        <div class="screen" id="audio-screen">
            <div class="trial-info" id="trial-counter">Trial 1 of 9</div>
            <div class="fixation-cross" id="fixation-cross" style="display: none;">+</div>
            <button class="start-audio-btn" id="start-audio-btn" onclick="startAudioPlayback()">Start Audio</button>
        </div>

        <!-- Rating Screen -->
        <div class="screen" id="rating-screen">
            <h2 id="rating-header">Rate Your Response</h2>
            <div class="audio-title" id="rating-song-title">Song Title</div>

            <!-- Valence Rating -->
            <div class="rating-section">
                <div class="rating-title">How positive or negative does this music make you feel?</div>
                <div class="rating-scale" id="valence-scale">
                    <div class="rating-option" data-value="1">
                        <img src="stimuli/SAM/valence1.png" alt="Very Negative">
                    </div>
                    <div class="rating-option blank" data-value="1.5"></div>
                    <div class="rating-option" data-value="2">
                        <img src="stimuli/SAM/valence2.png" alt="Negative">
                    </div>
                    <div class="rating-option blank" data-value="2.5"></div>
                    <div class="rating-option" data-value="3">
                        <img src="stimuli/SAM/valence3.png" alt="Neutral">
                    </div>
                    <div class="rating-option blank" data-value="3.5"></div>
                    <div class="rating-option" data-value="4">
                        <img src="stimuli/SAM/valence4.png" alt="Positive">
                    </div>
                    <div class="rating-option blank" data-value="4.5"></div>
                    <div class="rating-option" data-value="5">
                        <img src="stimuli/SAM/valence5.png" alt="Very Positive">
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Negative</span>
                    <span>Neutral</span>
                    <span>Positive</span>
                </div>
                <button class="skip-btn" onclick="skipValence()">Skip/Don't Remember</button>
            </div>

            <!-- Arousal Rating -->
            <div class="rating-section">
                <div class="rating-title">How intense is that feeling?</div>
                <div class="rating-scale" id="arousal-scale">
                    <div class="rating-option" data-value="1">
                        <img src="stimuli/SAM/arousal5.png" alt="Very Excited">
                    </div>
                    <div class="rating-option blank" data-value="1.5"></div>
                    <div class="rating-option" data-value="2">
                        <img src="stimuli/SAM/arousal4.png" alt="Excited">
                    </div>
                    <div class="rating-option blank" data-value="2.5"></div>
                    <div class="rating-option" data-value="3">
                        <img src="stimuli/SAM/arousal3.png" alt="Neutral">
                    </div>
                    <div class="rating-option blank" data-value="3.5"></div>
                    <div class="rating-option" data-value="4">
                        <img src="stimuli/SAM/arousal2.png" alt="Calm">
                    </div>
                    <div class="rating-option blank" data-value="4.5"></div>
                    <div class="rating-option" data-value="5">
                        <img src="stimuli/SAM/arousal1.png" alt="Very Calm">
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Neutral</span>
                    <span>Very Intense</span>
                </div>
                <button class="skip-btn" onclick="skipArousal()">Skip/Don't Remember</button>
            </div>

            <!-- Familiarity Rating -->
            <div class="rating-section">
                <div class="rating-title">How familiar were you with this music before today?</div>
                <div class="multiple-choice-container" id="familiarity-scale">
                    <div class="choice-option" data-value="1">1</div>
                    <div class="choice-option" data-value="2">2</div>
                    <div class="choice-option" data-value="3">3</div>
                    <div class="choice-option" data-value="4">4</div>
                    <div class="choice-option" data-value="5">5</div>
                    <div class="choice-option" data-value="6">6</div>
                    <div class="choice-option" data-value="7">7</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Not familiar at all</span>
                    <span>Very familiar</span>
                </div>
                <button class="skip-btn" onclick="skipFamiliarity()">Skip/Don't Remember</button>
            </div>

            <!-- Groove Rating -->
            <div class="rating-section">
                <div class="rating-title">How would you rate the "groove" of this music?</div>
                <div class="multiple-choice-container" id="groove-scale">
                    <div class="choice-option" data-value="0">0</div>
                    <div class="choice-option" data-value="1">1</div>
                    <div class="choice-option" data-value="2">2</div>
                    <div class="choice-option" data-value="3">3</div>
                    <div class="choice-option" data-value="4">4</div>
                    <div class="choice-option" data-value="5">5</div>
                    <div class="choice-option" data-value="6">6</div>
                    <div class="choice-option" data-value="7">7</div>
                    <div class="choice-option" data-value="8">8</div>
                    <div class="choice-option" data-value="9">9</div>
                    <div class="choice-option" data-value="10">10</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 10px;">
                    <span>Not groovy at all</span>
                    <span>Very groovy</span>
                </div>
                <button class="skip-btn" onclick="skipGroove()">Skip/Don't Remember</button>
            </div>

            <button class="btn continue-btn-bottom" id="continue-btn" onclick="nextTrial()" disabled>Continue</button>
        </div>

        <!-- Practice Complete Screen -->
        <div class="screen" id="practice-complete-screen">
            <div class="practice-header">
                <h2>Practice Complete!</h2>
            </div>
            <div class="intro-text">
                <p>You've completed the practice session.</p>
                <br>
                <p>Now you'll begin Block 1 of the main experiment with the same type of ratings.</p>
                <br>
                <p>Block 1 contains 9 music clips.</p>
            </div>
            <button class="btn" onclick="startMainExperiment()">Start Block 1</button>
        </div>

        <!-- Feedback Question Screen -->
        <div class="screen" id="feedback-screen">
            <h1>Final Question</h1>
            <div class="feedback-question">
                <div class="rating-title">How did you rate the songs? Would you say that you were rating the emotional impact of the song or how much you liked the song? Please enter your response below:</div>
                <textarea class="feedback-textarea" id="feedback-response" placeholder="Please describe your approach to rating the songs..."></textarea>
            </div>
            <button class="btn" onclick="submitFeedback()">Submit and Continue</button>
        </div>

        <!-- Completion Screen -->
        <div class="screen" id="completion-screen">
            <div class="completion-screen">
                <h1>Congratulations! You have completed Block 1.</h1>
                <p style="color: #ff4444; font-weight: bold; font-size: 1.2em; margin: 20px 0;">PLEASE MAKE SURE TO DOWNLOAD YOUR DATA BELOW</p>
                <button class="btn download-btn" onclick="downloadData()">Download Block 1 Data</button>
                <p style="margin: 20px 0;" id="completion-message">Close this tab and continue to the next block when you are ready by clicking on the next block on the home screen.</p>
            </div>
        </div>
    </div>

    <script>
        // Experiment Configuration
        const AUDIO_DURATION = 30000; // 30 seconds in milliseconds
        const PRACTICE_AUDIO_DURATION = 10000; // 10 seconds for practice
        const REPETITIONS_PER_SONG = 1; // Changed from 3 to 1
        
        // Block 1 songs (first 9 songs from original list)
        const DEMO_SONGS = [
            { 
                filename: 'stimuli/audio/1252', 
                title: '1252',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/dupleMeter_stereo_30sec', 
                title: 'Duple Meter Stereo',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/69', 
                title: '69',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/399', 
                title: '399',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/425', 
                title: '425',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/612', 
                title: '612',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/649', 
                title: '649',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/657', 
                title: '657',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/799', 
                title: '799',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            }
        ];

        // Practice songs - separate array for songs with "practice" in filename
        const PRACTICE_SONGS_LIST = [
            { 
                filename: 'stimuli/audio/practice1_808', 
                title: 'Practice 1',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            },
            { 
                filename: 'stimuli/audio/practice2_1092', 
                title: 'Practice 2',
                formats: ['.mp3', '.wav', '.m4a', '.ogg']
            }
        ];

        // Experiment State
        let participantId = 'participant_block1_' + Date.now();
        let currentTrial = 0;
        let trials = [];
        let experimentData = [];
        let practiceData = [];
        let currentAudio = null;
        let audioStartTime = 0;
        let surveyStartTime = 0;
        let valenceRating = null;
        let arousalRating = null;
        let familiarityRating = null;
        let grooveRating = null;
        let valenceRT = null;
        let arousalRT = null;
        let familiarityRT = null;
        let grooveRT = null;
        let isPractice = false;
        let practiceTrials = [];
        let currentSong = null;
        let feedbackResponse = '';
        let is